<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<meta name="description" content="Comunidad Digital Texcoco - El pulso digital de Texcoco. Conecta, comparte ideas y desarrolla oportunidades para crecer juntos.">
<meta name="keywords" content="CDT, CoDiTex, COmunidad DIgital Texcoco, Sistema Digital Texcoco">
<meta name="author" content="Comunidad Digital Texcoco">
<meta property="og:title" content="Comunidad Digital Texcoco">
<meta property="og:description" content="El pulso digital de Texcoco. Conecta, comparte ideas y desarrolla oportunidades para crecer juntos.">
<meta property="og:type" content="website">
<title>Comunidad Digital Texcoco</title>
<link rel="preconnect" href="https://fonts.gstatic.com">
<link rel="stylesheet" href="css/style.css">
<script src="js/script.js" defer></script>

</head>
<body>

<div id="cursor" class="cursor-circle"></div>

<script>
  const cursor = document.getElementById('cursor');
  document.addEventListener('mousemove', e => {
    cursor.style.left = e.clientX + 'px';
    cursor.style.top = e.clientY + 'px';
  });
</script>


  <!-- Animated background layers -->
  <div class="bg-animated" aria-hidden="true">
    <div class="grad"></div>
    <div class="stripes"></div>
    <div class="orb o1"></div>
    <div class="orb o2"></div>
    <div class="orb o3"></div>
  </div>

  <!-- Header -->
  <header class="navbar" role="banner">
    <div class="logo" aria-label="logo">
      <!-- Cambia logocdt.png por tu imagen -->
      <img src=img/logocdt.png alt="Logo Proyecto">
      <div class="brand">Comunidad Digital Texcoco Ver 12.7</div>
    </div>

    <div class="center-section" aria-hidden="false">
      <div class="title">El pulso digital de Texcoco.</div>
      <div class="desc">Somos una soluci√≥n digital en Texcoco donde emprendedores, creativos y ciudadanos<BR>
conectan, comparten ideas y desarrollan oportunidades para crecer juntos...</div>
    </div>

<div style="display:flex;gap:14px;align-items:center;">
<div id="contador">Cargando visitas CDT...</div>

 <script>
    // Traer el contador desde la API
    fetch('/api/visitas')
      .then(response => response.json())
      .then(data => {
        document.getElementById('contador').textContent = `El sitio ha sido visitado ${data.visitas} veces.`;
      })
      .catch(err => {
        document.getElementById('contador').textContent = 'No se pudo cargar el contador.';
        console.error(err);
      });
  </script>
             
      <!-- Bot√≥n Registro Gratis -->
      <button type="button" class="btn-register-header" onclick="toggleRegistroForm()">Registro Gratis</button>
      </div>
     </header>


<main class="container">
  <!-- Fichas de negocio -->

<section class="business-grid">

<div class="carousel-row" id="bizCarousel">
    <!-- Business cards will be loaded dynamically from database -->
  </div>

<script>
// Helper function to escape HTML to prevent XSS
function escapeHtml(text) {
  if (!text) return '';
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

// Load businesses from database (only those with estatusnegocio=1)
async function loadNegocios() {
  const carousel = document.getElementById('bizCarousel');
  try {
    const response = await fetch('/api/negocios');
    const negocios = await response.json();
    
    if (negocios.length === 0) {
      carousel.innerHTML = '<p style="color:#fff;text-align:center;width:100%;">No hay negocios registrados a√∫n.</p>';
      return;
    }
    
    carousel.innerHTML = '';
    
    negocios.forEach(negocio => {
      // Image source is frontend/img directory
      // imagen1 = filename from DB, imagen2 = filename + "2", imagen3 = filename + "3"
      const defaultImage = 'img/logocdt.png';
      
      const card = document.createElement('div');
      card.className = 'business-card';
      
      // Create slides container
      const slidesDiv = document.createElement('div');
      slidesDiv.className = 'slides';
      
      // Helper to build image URL from filename stored in imagen1
      // imagen1 = filename, imagen2 = filename + "2", imagen3 = filename + "3"
      const getImageUrl = (filename, suffix) => {
        if (!filename) return defaultImage;
        // Remove any path prefix if present, get just the filename
        const baseName = filename.split('/').pop();
        if (!baseName) return defaultImage;
        
        // Add suffix before the file extension if provided
        if (suffix) {
          const dotIndex = baseName.lastIndexOf('.');
          if (dotIndex > 0) {
            const name = baseName.substring(0, dotIndex);
            const ext = baseName.substring(dotIndex);
            return 'img/' + name + suffix + ext;
          }
          return 'img/' + baseName + suffix;
        }
        return 'img/' + baseName;
      };
      
      // Build images array from imagen1: imagen1, imagen1+2, imagen1+3
      // Image suffixes: '' for imagen1, '2' for imagen2, '3' for imagen3
      const IMAGE_SUFFIXES = ['', '2', '3'];
      const baseFilename = negocio.imagen1;
      const trimmedFilename = baseFilename ? baseFilename.trim() : '';
      if (trimmedFilename !== '' && trimmedFilename.toLowerCase() !== 'null') {
        // Create three images from imagen1 filename
        IMAGE_SUFFIXES.forEach((suffix, index) => {
          const slideDiv = document.createElement('div');
          slideDiv.className = 'slide' + (index === 0 ? ' active' : '');
          const img = document.createElement('img');
          img.src = getImageUrl(baseFilename, suffix);
          img.alt = escapeHtml(negocio.nombredenegocio);
          img.onerror = function() { 
            if (!this.dataset.errorHandled) {
              this.dataset.errorHandled = 'true';
              this.src = defaultImage; 
            }
          };
          slideDiv.appendChild(img);
          slidesDiv.appendChild(slideDiv);
        });
      } else {
        const slideDiv = document.createElement('div');
        slideDiv.className = 'slide active';
        const img = document.createElement('img');
        img.src = defaultImage;
        img.alt = escapeHtml(negocio.nombredenegocio);
        slideDiv.appendChild(img);
        slidesDiv.appendChild(slideDiv);
      }
      
      const cardInfo = document.createElement('div');
      cardInfo.className = 'card-info';
      
      const h3 = document.createElement('h3');
      h3.textContent = negocio.nombredenegocio || '';
      
      const p = document.createElement('p');
      p.textContent = negocio.descripcionnegocio || '';
      
      const loc = document.createElement('div');
      loc.className = 'loc';
      loc.textContent = 'üìû ' + (negocio.telnegocio || '');
      
      cardInfo.appendChild(h3);
      cardInfo.appendChild(p);
      cardInfo.appendChild(loc);
      
      card.appendChild(slidesDiv);
      card.appendChild(cardInfo);
      carousel.appendChild(card);
    });
    
    // Initialize slide animation for dynamically loaded cards
    initCardSlides();
  } catch (err) {
    console.error('Error al cargar negocios:', err);
    carousel.innerHTML = '<p style="color:#fff;text-align:center;width:100%;">Error al cargar negocios.</p>';
  }
}

function initCardSlides() {
  document.querySelectorAll('.business-card').forEach(card => {
    const slides = card.querySelectorAll('.slide');
    if (slides.length <= 1) return;
    
    let idx = 0, t;
    function show(i) {
      slides.forEach((s, si) => s.classList.toggle('active', si === i));
    }
    function start() {
      t = setInterval(() => {
        idx = (idx + 1) % slides.length;
        show(idx);
      }, 3000 + Math.random() * 1200);
    }
    start();
    // Note: Image slideshow continues even when card is hovered
    // Only the carousel movement stops (via CSS animation-play-state)
  });
}

// Load negocios on page load
loadNegocios();
</script>

</section>

</main>

  <!-- Beneficios -->
  <section class="benefits" id="beneficios">
    <div class="benefit">
      <h3>üì¢ M√°s visibilidad</h3>
      <p>Muestra lo bonito de tu negocio en nuestra comunidad digital y llega a m√°s clientes.</p>
    </div>
    <div class="benefit">
      <h3>ü§ù Conexi√≥n local</h3>
      <p>Haz alianzas con otros emprendedores de Texcoco.<br>
         (Mantenimiento, Publicidad, Impresores, Transporte, etc.)</p>
    </div>
    <div class="benefit">
      <h3>üíª Digitalizaci√≥n F√°cil</h3>
      <p>Sin costo, sin complicaciones, con solo un registro.</p>
    </div>
    <div class="benefit">
      <h3>üöÄ Crecimiento real</h3>
      <p>M√°s clientes, m√°s oportunidades, m√°s futuro.</p>
    </div>
  </section>

<section class="registro-container" id="registroContainer" style="display: none;">
    <h2>Registra tu Negocio en nuestra Comunidad Digital</h2>


<form id="regForm">
  <div class="form-group">
    <label for="contacto">Nombre de contacto</label>
    <input type="text" id="contacto" placeholder="Ej. Juan P√©rez" required>
  </div>

  <div class="form-group">
    <label for="nomnegocio">Nombre de negocio</label>
    <input type="text" id="nomnegocio" placeholder="Ej. Abarrotes Texcoco" required>
  </div>

  <div class="form-group">
    <label for="telefono">Tel√©fono</label>
    <input type="tel" id="telefono" placeholder="Ej. 595-123-4567" required>
  </div>

  <div class="form-group">
    <label for="descripcion">Descripci√≥n del negocio</label>
    <textarea id="descripcion" placeholder="Breve descripci√≥n..." required></textarea>
  </div>

  <div class="form-group">
    <label for="tiponegocio">Tipo de negocio</label>
    <select id="tiponegocio" required>
      <option value="">Selecciona una opci√≥n</option>
      <option value="VTA a GRANEL">VTA a GRANEL</option>
      <option value="ABARROTES">ABARROTES</option>
      <option value="ALIMENTO">ALIMENTO</option>
      <option value="ACCESORIOS">ACCESORIOS</option>
      <option value="SERVICIOS">SERVICIOS</option>
      <option value="MASCOTAS">MASCOTAS</option>
      <option value="CONSULTORIO">CONSULTORIO</option>
      <option value="OTRO">OTRO</option>
    </select>
  </div>

  <div class="form-group">
    <label for="imagen1">Imagen 1 (m√°x. 4MB)</label>
    <input type="file" id="imagen1" accept="image/*">
  </div>

  <div class="form-group">
    <label for="imagen2">Imagen 2 (m√°x. 4MB)</label>
    <input type="file" id="imagen2" accept="image/*">
  </div>

  <div class="form-group">
    <label for="imagen3">Imagen 3 (m√°x. 4MB)</label>
    <input type="file" id="imagen3" accept="image/*">
  </div>

  <div class="form-group">
    <label for="ubinegocio">Ubicaci√≥n (URL de Google Maps)</label>
    <input type="url" id="ubinegocio" placeholder="https://maps.google.com/...">
  </div>

  <div style="display: flex; gap: 10px;">
    <button type="submit" class="btn-submit">Registrar mi negocio</button>
    <button type="button" class="btn-cancel" onclick="cancelarRegistro()">Cancelar</button>
  </div>

<div class="aviso-container">
  <span id="avisoToggle" class="aviso-link">AVISO DE PRIVACIDAD</span>
  <div id="avisoBubble" class="aviso-bubble">
    <h4>Aviso de Privacidad</h4>
    <p>
      Este sitio web respeta tu privacidad. Los datos recolectados ser√°n usados √∫nicamente
      para fines de registro y contacto de negocios, conforme a la Ley de Protecci√≥n de Datos.
      No compartimos informaci√≥n con terceros sin tu consentimiento.
    </p>
  </div>
</div>

</form>

<script>
// Toggle form visibility
function toggleRegistroForm() {
  const container = document.getElementById('registroContainer');
  if (container.style.display === 'none' || container.style.display === '') {
    container.style.display = 'block';
    container.scrollIntoView({ behavior: 'smooth' });
  } else {
    container.style.display = 'none';
  }
}

// Cancel and hide form
function cancelarRegistro() {
  const form = document.getElementById('regForm');
  form.reset();
  document.getElementById('registroContainer').style.display = 'none';
}

const form = document.getElementById("regForm");

// Max file size: 4MB
const MAX_FILE_SIZE = 4 * 1024 * 1024;

form.addEventListener("submit", async function(e) {
  e.preventDefault();

  const contacto = document.getElementById("contacto").value;
  const nomnegocio = document.getElementById("nomnegocio").value;
  const telefono = document.getElementById("telefono").value;
  const descripcion = document.getElementById("descripcion").value;
  const tiponegocio = document.getElementById("tiponegocio").value;
  const ubinegocio = document.getElementById("ubinegocio").value;
  
  // Get file inputs
  const imagen1File = document.getElementById("imagen1").files[0];
  const imagen2File = document.getElementById("imagen2").files[0];
  const imagen3File = document.getElementById("imagen3").files[0];
  
  // Validate file sizes (max 4MB each)
  const files = [imagen1File, imagen2File, imagen3File].filter(f => f);
  for (const file of files) {
    if (file.size > MAX_FILE_SIZE) {
      alert(`‚ùå El archivo "${file.name}" excede el l√≠mite de 4MB.`);
      return;
    }
  }

  // Create FormData for file upload
  const formData = new FormData();
  formData.append('nombredenegocio', nomnegocio);
  formData.append('propietario', contacto);
  formData.append('telnegocio', telefono);
  formData.append('descripcionnegocio', descripcion);
  formData.append('tiponegocio', tiponegocio);
  formData.append('ubinegocio', ubinegocio);
  
  if (imagen1File) formData.append('imagen1', imagen1File);
  if (imagen2File) formData.append('imagen2', imagen2File);
  if (imagen3File) formData.append('imagen3', imagen3File);

  try {
    const res = await fetch('/api/negocios', {
      method: 'POST',
      body: formData
    });

    const msg = await res.text();
    console.log(msg);
    alert(msg);

  } catch(err) {
    console.error('Error al guardar en DB:', err);
    alert('‚ùå Error al guardar negocio');
  }

  form.reset();
  document.getElementById('registroContainer').style.display = 'none';
});


</script>


  </section>

    <!-- Footer -->
    <footer class="site-footer">
      <div>¬© 2025 Comunidad Digital Texcoco</div>

    </footer>
  </main>



<script>
// Obtener contador del localStorage (persistencia local)

  let visitas = localStorage.getItem('contadorVisitas') || 0;
  visitas = parseInt(visitas) + 1;
  localStorage.setItem('contadorVisitas', visitas);

/* ---------- Mini slide in Comunidad (3 images) ---------- */
(function(){
  const container = document.getElementById('miniSlide');
  if(!container) return;
  const imgs = Array.from(container.querySelectorAll('img'));
  let i=0;
  function show(j){ imgs.forEach((img,idx)=> img.style.display = idx===j ? 'block' : 'none'); }
  show(0);
  setInterval(()=>{ i = (i+1) % imgs.length; show(i); }, 3500);
})();



/* ---------- Accessibility: reduce motion respect ---------- */
if(window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches){
  document.querySelectorAll('.bg-animated .orb').forEach(o=> o.style.animation = 'none');
  document.querySelectorAll('.slides .slide').forEach(s=> s.style.transition = 'none');
}



// JavaScript
const avisoLink = document.getElementById('avisoToggle');
const avisoBubble = document.getElementById('avisoBubble');

avisoLink.addEventListener('click', () => {
  // Alterna la visibilidad de la burbuja
  avisoBubble.style.display = avisoBubble.style.display === 'block' ? 'none' : 'block';
});

// Opcional: cerrar la burbuja al hacer click fuera
document.addEventListener('click', (e) => {
  if (!avisoLink.contains(e.target) && !avisoBubble.contains(e.target)) {
    avisoBubble.style.display = 'none';
  }
});
</script>
</body>
</html>